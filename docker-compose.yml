services:
  # Kali Linux Jump Box
  kali-jump:
    image: epic-research-infra-kali-jump:latest
    build: ./kali-jump
    container_name: kali-jump-${STUDENT_ID:-test}
    hostname: kali-jump
    networks:
      cyber-lab-internal:
        ipv4_address: 10.${SUBNET_ID:-0}.1.10
    ports:
      - "${SSH_BIND:-127.0.0.1}:${SSH_PORT:-2222}:22"  # External SSH access (localhost by default, 0.0.0.0 for lab manager)
    cap_add:
      - NET_ADMIN  # Seems to be required for nmap to work
    labels:
      - "lab.student.id=${STUDENT_ID:-test}"
      - "lab.student.name=${STUDENT_NAME:-Test User}"
      - "lab.student.port=${SSH_PORT:-2222}"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
          pids: 128

  # Ubuntu Target 1
  ubuntu-target1:
    image: epic-research-infra-ubuntu-target1:latest
    platform: linux/amd64
    stop_grace_period: 1s
    build: ./ubuntu-target1
    container_name: file-server-${STUDENT_ID:-test}
    hostname: file-server
    networks:
      cyber-lab-internal:
        ipv4_address: 10.${SUBNET_ID:-0}.1.11
    labels:
      - "lab.student.id=${STUDENT_ID:-test}"
      - "lab.student.name=${STUDENT_NAME:-Test User}"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
          pids: 128
  
  # Ubuntu target 2
  secret-target:
    image: epic-research-infra-ubuntu-target2:latest
    stop_grace_period: 1s
    build: ./ubuntu-target2
    container_name: build-server-${STUDENT_ID:-test}
    hostname: build-server
    networks:
      cyber-lab-internal:
        # this target uses a different nonconsecutive IP to encourage students to scan the network
        ipv4_address: 10.${SUBNET_ID:-0}.1.231
    labels:
      - "lab.student.id=${STUDENT_ID:-test}"
      - "lab.student.name=${STUDENT_NAME:-Test User}"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
          pids: 128

networks:
  # Internal Network - Kali Jump Box, Ubuntu Target 1, Ubuntu Target 2
  cyber-lab-internal:
    name: ${NETWORK_NAME:-cyber-lab-test}-internal
    driver: bridge
    ipam:
      config:
        - subnet: 10.${SUBNET_ID:-172}.42.0/24
          gateway: 10.${SUBNET_ID:-172}.42.1